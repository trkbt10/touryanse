<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>通りゃんせ 信号機エミュレータ</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #fff;
    }
    h1 {
      margin: 0 0 10px 0;
      font-size: 1.8em;
      text-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    .subtitle {
      color: #8892b0;
      margin-bottom: 30px;
      font-size: 0.9em;
    }
    .signal-box {
      background: #2d2d2d;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.4);
      border: 3px solid #444;
    }
    .lights {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
    }
    .light {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 4px solid #555;
      transition: all 0.3s ease;
    }
    .light.red {
      background: #331111;
      box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
    }
    .light.yellow {
      background: #332211;
      box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
    }
    .light.green {
      background: #113311;
      box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
    }
    .light.red.active {
      background: radial-gradient(circle at 30% 30%, #ff6666, #cc0000);
      box-shadow: 0 0 30px #ff0000, 0 0 60px #ff000066;
    }
    .light.green.active {
      background: radial-gradient(circle at 30% 30%, #66ff66, #00cc00);
      box-shadow: 0 0 30px #00ff00, 0 0 60px #00ff0066;
    }
    .controls {
      display: flex;
      flex-direction: column;
      gap: 15px;
      align-items: center;
    }
    button {
      background: linear-gradient(180deg, #4a90d9, #357abd);
      color: white;
      border: none;
      padding: 15px 40px;
      font-size: 1.1em;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 4px 15px rgba(74, 144, 217, 0.4);
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(74, 144, 217, 0.6);
    }
    button:active {
      transform: translateY(0);
    }
    button:disabled {
      background: #555;
      cursor: not-allowed;
      box-shadow: none;
    }
    .status {
      color: #8892b0;
      font-size: 0.85em;
      height: 20px;
    }
    .info {
      max-width: 400px;
      margin-top: 30px;
      padding: 20px;
      background: rgba(255,255,255,0.05);
      border-radius: 10px;
      font-size: 0.85em;
      line-height: 1.6;
      color: #8892b0;
    }
    .info h3 {
      color: #ccd6f6;
      margin: 0 0 10px 0;
      font-size: 1em;
    }
    .lyrics {
      margin-top: 20px;
      padding: 15px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      font-size: 0.9em;
      color: #64ffda;
      text-align: center;
      min-height: 50px;
      transition: opacity 0.3s;
    }
  </style>
</head>
<body>
  <h1>通りゃんせ 信号機エミュレータ</h1>
  <p class="subtitle">視覚障害者用付加装置 RUH-5 音色再現</p>

  <div class="signal-box">
    <div class="lights">
      <div class="light red" id="redLight"></div>
      <div class="light yellow"></div>
      <div class="light green" id="greenLight"></div>
    </div>
    <div class="controls">
      <button id="playBtn">再生</button>
      <div class="status" id="status"></div>
    </div>
  </div>

  <div class="lyrics" id="lyrics"></div>

  <div class="info">
    <h3>音色の特徴</h3>
    <p>
      信号機スピーカー（RUH-5）の帯域特性（600Hz〜6kHz）を再現。
      矩形波をベースに、基音を削り高次倍音（3/5/7/9倍）を強調。
      2.3kHz付近のホーン共鳴をピーキングフィルタで再現しています。
    </p>
  </div>

  <script>
    // AudioContext初期化
    let audioCtx = null;

    function getAudioContext() {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      return audioCtx;
    }

    // 音符の周波数定義（ヨナ抜き音階ベース）
    // 信号機は少し低めの音程で鳴る傾向があるので、やや低めに設定
    const NOTE = {
      // オクターブ4
      E4: 329.63,
      G4: 392.00,
      A4: 440.00,
      B4: 493.88,
      // オクターブ5
      C5: 523.25,
      D5: 587.33,
      E5: 659.25,
      G5: 783.99,
    };

    // 「通りゃんせ」メロディデータ
    // 信号機で使われる典型的なフレーズ
    // [周波数, 開始時間(拍), 長さ(拍)]
    // テンポ: 1拍 = 約300ms（ゆったり）
    const BEAT = 0.30; // 1拍の長さ（秒）
    const NOTE_DUR = 0.22; // 音符の実際の発音時間

    // 歌詞データ（タイミング同期用）
    const LYRICS = [
      { time: 0, text: "とお りゃん せ" },
      { time: 5, text: "とお りゃん せ" },
      { time: 10, text: "ここは どこの" },
      { time: 15, text: "ほそ みち じゃ" },
      { time: 21, text: "てん じん さまの" },
      { time: 27, text: "ほそ みち じゃ" },
      { time: 33, text: "ちっと とおして" },
      { time: 39, text: "くだ しゃん せ" },
      { time: 45, text: "ごようの ないもの" },
      { time: 51, text: "とお しゃ せぬ" },
      { time: 57, text: "このこの ななつの" },
      { time: 63, text: "おいわい に" },
      { time: 69, text: "おふだを おさめに" },
      { time: 75, text: "まい ります" },
      { time: 81, text: "いきは よい よい" },
      { time: 87, text: "かえりは こわい" },
      { time: 93, text: "こわい ながらも" },
      { time: 99, text: "とお りゃん せ" },
      { time: 104, text: "とお りゃん せ" },
    ];

    // 「通りゃんせ」完全版メロディ
    const MELODY = [
      // とおりゃんせ (1)
      [NOTE.G4, 0, 1],
      [NOTE.G4, 1, 1],
      [NOTE.A4, 2, 1],
      [NOTE.G4, 3, 0.5],
      [NOTE.E4, 3.5, 1.5],
      // とおりゃんせ (2)
      [NOTE.G4, 5, 1],
      [NOTE.G4, 6, 1],
      [NOTE.A4, 7, 1],
      [NOTE.G4, 8, 0.5],
      [NOTE.E4, 8.5, 1.5],
      // ここはどこの
      [NOTE.G4, 10, 1],
      [NOTE.A4, 11, 1],
      [NOTE.B4, 12, 1],
      [NOTE.B4, 13, 0.5],
      [NOTE.B4, 13.5, 0.5],
      // ほそみちじゃ
      [NOTE.A4, 15, 1],
      [NOTE.B4, 16, 1],
      [NOTE.C5, 17, 0.5],
      [NOTE.B4, 17.5, 0.5],
      [NOTE.A4, 18, 0.5],
      [NOTE.G4, 18.5, 1.5],
      // てんじんさまの
      [NOTE.G4, 21, 0.5],
      [NOTE.A4, 21.5, 0.5],
      [NOTE.B4, 22, 1],
      [NOTE.B4, 23, 0.5],
      [NOTE.B4, 23.5, 0.5],
      [NOTE.B4, 24, 0.5],
      [NOTE.B4, 24.5, 0.5],
      // ほそみちじゃ
      [NOTE.A4, 27, 1],
      [NOTE.B4, 28, 1],
      [NOTE.C5, 29, 0.5],
      [NOTE.B4, 29.5, 0.5],
      [NOTE.A4, 30, 0.5],
      [NOTE.G4, 30.5, 1.5],
      // ちっととおして
      [NOTE.D5, 33, 1],
      [NOTE.D5, 34, 0.5],
      [NOTE.B4, 34.5, 0.5],
      [NOTE.D5, 35, 1],
      [NOTE.D5, 36, 0.5],
      [NOTE.B4, 36.5, 0.5],
      // くだしゃんせ
      [NOTE.A4, 39, 1],
      [NOTE.G4, 40, 1],
      [NOTE.A4, 41, 1],
      [NOTE.G4, 42, 0.5],
      [NOTE.E4, 42.5, 1.5],
      // ごようのないもの
      [NOTE.D5, 45, 1],
      [NOTE.D5, 46, 0.5],
      [NOTE.B4, 46.5, 0.5],
      [NOTE.D5, 47, 1],
      [NOTE.D5, 48, 0.5],
      [NOTE.B4, 48.5, 0.5],
      // とおしゃせぬ
      [NOTE.A4, 51, 1],
      [NOTE.G4, 52, 1],
      [NOTE.A4, 53, 1],
      [NOTE.G4, 54, 0.5],
      [NOTE.E4, 54.5, 1.5],
      // このこのななつの
      [NOTE.E5, 57, 1],
      [NOTE.E5, 58, 0.5],
      [NOTE.D5, 58.5, 0.5],
      [NOTE.E5, 59, 1],
      [NOTE.E5, 60, 0.5],
      [NOTE.D5, 60.5, 0.5],
      // おいわいに
      [NOTE.B4, 63, 1],
      [NOTE.D5, 64, 1],
      [NOTE.B4, 65, 0.5],
      [NOTE.A4, 65.5, 0.5],
      [NOTE.G4, 66, 2],
      // おふだをおさめに
      [NOTE.E5, 69, 1],
      [NOTE.E5, 70, 0.5],
      [NOTE.D5, 70.5, 0.5],
      [NOTE.E5, 71, 1],
      [NOTE.E5, 72, 0.5],
      [NOTE.D5, 72.5, 0.5],
      // まいります
      [NOTE.B4, 75, 1],
      [NOTE.D5, 76, 1],
      [NOTE.B4, 77, 0.5],
      [NOTE.A4, 77.5, 0.5],
      [NOTE.G4, 78, 2],
      // いきはよいよい
      [NOTE.G4, 81, 1],
      [NOTE.A4, 82, 1],
      [NOTE.B4, 83, 1],
      [NOTE.D5, 84, 1],
      [NOTE.B4, 85, 1],
      // かえりはこわい
      [NOTE.A4, 87, 1],
      [NOTE.B4, 88, 1],
      [NOTE.A4, 89, 1],
      [NOTE.G4, 90, 0.5],
      [NOTE.E4, 90.5, 1.5],
      // こわいながらも
      [NOTE.G4, 93, 1],
      [NOTE.A4, 94, 1],
      [NOTE.B4, 95, 1],
      [NOTE.D5, 96, 1],
      [NOTE.B4, 97, 1],
      // とおりゃんせ (最後1)
      [NOTE.A4, 99, 1],
      [NOTE.G4, 100, 1],
      [NOTE.A4, 101, 1],
      [NOTE.G4, 102, 0.5],
      [NOTE.E4, 102.5, 1.5],
      // とおりゃんせ (最後2)
      [NOTE.G4, 104, 1],
      [NOTE.G4, 105, 1],
      [NOTE.A4, 106, 1],
      [NOTE.G4, 107, 0.5],
      [NOTE.E4, 107.5, 2.5],
    ];

    /**
     * 信号機スピーカー（RUH-5）の音色を再現するオーディオチェーンを作成
     * - 矩形波で豊富な倍音を生成
     * - 600Hzハイパスで基音を削る
     * - 2300Hz付近をブーストしてホーンの"鳴り"を再現
     * - 6kHzローパスで帯域制限
     */
    function createSignalToneChain(ctx) {
      // オシレータ（矩形波）
      const osc = ctx.createOscillator();
      osc.type = "square";

      // ハイパスフィルタ（600Hz）- 基音を削る
      const highpass = ctx.createBiquadFilter();
      highpass.type = "highpass";
      highpass.frequency.value = 600;
      highpass.Q.value = 0.7;

      // ピーキングフィルタ（2300Hz）- ホーンの共鳴を再現
      const peaking = ctx.createBiquadFilter();
      peaking.type = "peaking";
      peaking.frequency.value = 2300;
      peaking.Q.value = 4;
      peaking.gain.value = 10;

      // ローパスフィルタ（6000Hz）- 帯域制限
      const lowpass = ctx.createBiquadFilter();
      lowpass.type = "lowpass";
      lowpass.frequency.value = 6000;
      lowpass.Q.value = 0.7;

      // ゲインノード（エンベロープ用）
      const gain = ctx.createGain();
      gain.gain.value = 0;

      // 接続
      osc.connect(highpass);
      highpass.connect(peaking);
      peaking.connect(lowpass);
      lowpass.connect(gain);
      gain.connect(ctx.destination);

      return { osc, gain };
    }

    /**
     * 「パッ」という短いエンベロープで1音を再生
     */
    function playNote(ctx, freq, startTime, duration) {
      const { osc, gain } = createSignalToneChain(ctx);

      osc.frequency.setValueAtTime(freq, startTime);

      const amplitude = 0.15; // 音量
      const attack = 0.008;   // アタック（速い立ち上がり）
      const release = 0.08;   // リリース（すぐ減衰）

      // エンベロープ設定
      gain.gain.setValueAtTime(0, startTime);
      gain.gain.linearRampToValueAtTime(amplitude, startTime + attack);
      gain.gain.setValueAtTime(amplitude, startTime + duration - release);
      gain.gain.exponentialRampToValueAtTime(0.0001, startTime + duration);

      osc.start(startTime);
      osc.stop(startTime + duration + 0.05);
    }

    /**
     * メロディ全体を再生
     */
    function playMelody() {
      const ctx = getAudioContext();

      // AudioContextがsuspended状態なら再開
      if (ctx.state === 'suspended') {
        ctx.resume();
      }

      const startTime = ctx.currentTime + 0.1;

      // 全ての音符をスケジュール
      MELODY.forEach(([freq, beat, dur]) => {
        const noteStart = startTime + beat * BEAT;
        const noteDur = dur * BEAT * 0.85; // 少し短めにして隙間を作る
        playNote(ctx, freq, noteStart, noteDur);
      });

      // 総再生時間を計算
      const lastNote = MELODY[MELODY.length - 1];
      const totalDuration = (lastNote[1] + lastNote[2]) * BEAT;

      return { startTime, totalDuration };
    }

    // UI制御
    const playBtn = document.getElementById('playBtn');
    const statusEl = document.getElementById('status');
    const lyricsEl = document.getElementById('lyrics');
    const redLight = document.getElementById('redLight');
    const greenLight = document.getElementById('greenLight');

    let isPlaying = false;
    let lyricsInterval = null;

    function updateLyrics(startTime, totalDuration) {
      let lyricIndex = 0;
      const ctx = getAudioContext();

      lyricsInterval = setInterval(() => {
        const elapsed = ctx.currentTime - startTime;
        const currentBeat = elapsed / BEAT;

        // 現在の歌詞を探す
        while (lyricIndex < LYRICS.length - 1 &&
               LYRICS[lyricIndex + 1].time <= currentBeat) {
          lyricIndex++;
        }

        if (lyricIndex < LYRICS.length) {
          lyricsEl.textContent = LYRICS[lyricIndex].text;
        }

        // 終了判定
        if (elapsed >= totalDuration) {
          clearInterval(lyricsInterval);
        }
      }, 50);
    }

    playBtn.addEventListener('click', async () => {
      if (isPlaying) return;

      isPlaying = true;
      playBtn.disabled = true;
      playBtn.textContent = '再生中...';
      statusEl.textContent = '';

      // 信号を青に
      redLight.classList.remove('active');
      greenLight.classList.add('active');

      try {
        const { startTime, totalDuration } = playMelody();

        // 歌詞表示開始
        updateLyrics(startTime, totalDuration);

        // 再生完了を待つ
        await new Promise(resolve => setTimeout(resolve, totalDuration * 1000 + 500));

      } catch (err) {
        statusEl.textContent = 'エラー: ' + err.message;
        console.error(err);
      }

      // 信号を赤に戻す
      greenLight.classList.remove('active');
      redLight.classList.add('active');

      lyricsEl.textContent = '';
      playBtn.disabled = false;
      playBtn.textContent = '再生';
      isPlaying = false;

      if (lyricsInterval) {
        clearInterval(lyricsInterval);
      }
    });

    // 初期状態：赤信号
    redLight.classList.add('active');
  </script>
</body>
</html>
